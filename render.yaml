# Render Blueprint - OpenDexViewer
# Deploy with: render blueprint apply
# Documentation: https://render.com/docs/blueprint-spec
#
# NOTE: Static sites cannot be created via blueprint.
# After deploying this blueprint, manually create the frontend static site.

services:
  # =====================================================
  # Backend API Service
  # =====================================================
  - type: web
    name: opendex-api
    runtime: node
    region: oregon
    plan: free
    rootDir: backend
    buildCommand: npm install
    startCommand: npm start
    healthCheckPath: /health
    envVars:
      # Database connection (auto-populated from Render PostgreSQL)
      - key: DATABASE_URL
        fromDatabase:
          name: opendex-db
          property: connectionString

      # API Keys (set these manually in Render dashboard)
      - key: HELIUS_API_KEY
        sync: false
      - key: BIRDEYE_API_KEY
        sync: false

      # Application settings
      - key: NODE_ENV
        value: production

      # CORS - Update this to your actual frontend URL
      - key: CORS_ORIGIN
        value: https://opendex-frontend.onrender.com

      # Rate limiting configuration
      - key: RATE_LIMIT_WINDOW_MS
        value: "60000"
      - key: RATE_LIMIT_MAX_REQUESTS
        value: "100"

      # Cache settings (seconds)
      - key: CACHE_TOKEN_TTL
        value: "300"
      - key: CACHE_PRICE_TTL
        value: "60"

      # Auto-moderation thresholds
      - key: AUTO_APPROVE_THRESHOLD
        value: "5"
      - key: AUTO_REJECT_THRESHOLD
        value: "-5"

# =====================================================
# PostgreSQL Database
# =====================================================
databases:
  - name: opendex-db
    plan: free
    region: oregon
    databaseName: opendex
    user: opendex_user

# =====================================================
# MANUAL STEP REQUIRED:
# After blueprint deployment, create a Static Site manually:
#
# 1. Go to Render Dashboard > New > Static Site
# 2. Connect your GitHub repository
# 3. Configure:
#    - Name: opendex-frontend
#    - Root Directory: frontend
#    - Build Command: echo "No build needed"
#    - Publish Directory: .
# 4. Add these rewrite rules in Settings > Redirects/Rewrites:
#    - Source: /token/*  -> Destination: /token.html (Rewrite)
#    - Source: /submit   -> Destination: /submit.html (Rewrite)
# =====================================================
